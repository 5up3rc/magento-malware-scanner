
[![Winkle approves](https://buq.eu/screenshots/Screenshot_2016-11-24_15-27-34.png)](https://twitter.com/philwinkle/status/801536792407212033)

# Magento Malware Scanner

![small germ](https://buq.eu/img/small-germ.jpg)

A collection of rules to detect frontend and backend malware. The malicious stuff was found in the wild on Magento sites.

Purpose: demonstrate ingeniuity of cyber thieves

Secondary purpose: help administrators to automatically detect and disarm malware on their systems.

# Test coverage

Travis-CI verifies that all samples are detected and all signatures match at least one sample: [![Build Status](https://travis-ci.org/gwillem/magento-malware-scanner.svg?branch=master)](https://travis-ci.org/gwillem/magento-malware-scanner)

# Context

For our free [MageReport](https://www.magereport.com) service we've already been collecting malware samples to aid in fingerprint development and detecting compromised sites. Now, many responsible hosting providers and system administrators are doing the same work. That's incredibly inefficient. 

Goal:

> Once a particular strain of malware has been found and analyzed, nobody should have to duplicate these efforts.

Yes, there are many other projects to share malware signatures. However, as 2016 has become the Year of Magento Malware, I 
feel there's a significant edge to focus solely on Magento malware. This permits certain assumptions on the codebase. For example, new signatures can be validated against all Magento releases and all extensions ever published.

Maintaining malware databases is hard. It's all about standardization, low submission barriers, automated test procedures. I hope this effort saves somebody some valuable time.

Contributions most welcome.

# Howto

```bash
# Install prerequisites on Debian/Ubuntu flavoured server
sudo apt install yara python3

# Install prerequisites on a Mac OSX environemnt
brew install yara python3

# Checkout repository. 
git clone https://github.com/gwillem/magento-malware-scanner.git
cd magento-malware-collection

# Run scan on your files
yara -r rules/all-confirmed.yar /var/www

# Run tests to validate signatures and samples
python tools/runtests.py
```

# Strategies for writing signatures

Malware signatures can be extremely specific (a file checksum) to generic (check for suspicious `eval()`) or anything in between. As a signature author, you have to decide on a proper balance. Pro specific: no chance for false positives. Pro generic: less work, as one signature will catch multiple strains of malware.

> In case of doubt, choose specific. 

Taking a shortcut with a more generic signature might be tempting, but if it causes false positives (possibly in the future), you will have to deal with the fallout, _plus_ have to repeat your malware analysis.  

Remember, we can already win a lot by de-duplicating unique malware instance identification across organisations. Identifying future, or merely suspicious, malware is also desireable but requires a different strategy.

Other malware research suggests that malwares are quickly morphing, rendering the average lifespan of a unique malware instance to be [only 58 seconds](https://twitter.com/jeremiahg/status/799734794737184768). But I haven't seen this behaviour in Magento specific malware yet. Let's enjoy the tide while it lasts.
