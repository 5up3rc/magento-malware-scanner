How to
======

This document will briefly cover the most important aspects of the magento-malware-scanner.

1. Installation
2. How to use the Scanner
3. How to add malware

# 1. Installation

The requirements for the magento-malware-scanner to work are:

* python3
* yara

__Installation on Debian/Ubuntu flavoured server__

```bash
# Install prerequisites on Debian/Ubuntu flavoured server
sudo apt install yara python3
```
__Installation on a Mac OSX environment__

```bash
# Install prerequisites on a Mac OSX environemnt
brew install yara python3
```

__Checkout repository

```bash
# Checkout repository. 
git clone https://github.com/gwillem/magento-malware-scanner.git
cd magento-malware-collection
```
__Verify that everything is working__

```bash
# Run tests to validate signatures and samples
python tools/runtests.py
```

# 2. How to use the Scanner

After installing the requirements, a scan can be initiated with basically 3 ingredients in a terminal command.

1. yara
2. yara rules (./rules/all-confirmed.yar)
3. target (Magento document root)

__Example recursive scan__

```bash
yara -r /path/to/magento-scanner/rules/all-confirmed.yar /path/to/magento/document-root
```

When there's malware detected, your output will look something similar like:

```
$ yara -r rules/all-confirmed.yar /Users/frosit/Werk/Security/mage17

eval_post /Users/frosit/Werk/Security/mage17/media/dhl/info.php
obfuscated_eval /Users/frosit/Werk/Security/mage17/skin/backdoor1.php
```

# 3. How to add malware

After installing the requirements, malware can be added by following these steps.

## Gather your malware samples

Gather your malware samples in the _./malware/incoming_ folder of the magento-malware-scanner. It is advised to first verify that the malware isn't already detected by the current set of rules.

```bash
yara -r ./rules/all-confirmed.yar ./malware/incoming
```
If your sample is already detected for the right reasons, you may skip this sample.

## Process the samples

Running `md5_to_incoming.sh` will move your samples to the malware/backend directory and rename them with an md5 checksum.

```bash
./tools/md5_to_incoming.sh
```

We can now generate boilerplate rules using `tools/runtests.py`. This will make sure that each sample is covered by a YARA rule. If not, a boilerplate rule will be in the output for you to use.

__example output__

```
// malware/backend/4c4b3d4ba5bce7191a5138efa2468679
rule md5_4c4b3d4ba5bce7191a5138efa2468679 {
    strings: $ = ""
    condition: any of them
}
```

Copy over the boilerplate rule(s) to `rules/backend.yar` and start editing them.

## Creating rules

Using the boilerplate rules, creating a rule can be as simple as defining a string to match.
Malware signatures can be extremely specific (a file checksum) or too generic (check for suspicious `eval()`).

__Example malware__

```PHP
<?php @eval(stripslashes($_REQUEST[q]));
```
__Example rule__

```
rule md5_d201d61510f7889f1a47257d52b15fa2 { // rule name (sample filename or descriptive name)
    strings: $ = "@eval(stripslashes($_REQUEST[q]));" // string(s) to match
    condition: any of them  // conditions
}
```

The above example is simple and sufficient. More advanced samples may require more complex signatures. One signature can cover multiple strains of malware. A signature can also _raise a false positive which should be prevented at all costs_. You have to decide on a _proper balance_.

__When in doubt, go specific__ as it has the least chance to raise a false flag. 

For more information on writing rules, refer to the documentation below

* [Writing YARA rules](http://yara.readthedocs.io/en/v3.5.0/writingrules.html)
* [YARA in a Nutshell](http://virustotal.github.io/yara/)
* [Example Yara Rules](https://github.com/Yara-Rules/rules)
