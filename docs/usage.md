# Usage 

See also [contributing](contributing.md).

Two ways to get started

1. Easy usage for store owners, no need for extra software
1. Full install for system administrators, with support for:
	1. Incremental scans: only display hits for new files. Plus, normal scanning may use lots of server power. So only scanning new files is a great optimization.
	1. Faster scanning: using Yara is 4-20x times faster than grep. 
	1. Efficient whitelisting: some extension vendors have obfuscated their code so that it looks exactly like malware. We maintain a list of bad-looking-but-good-code to save you some false alarms. 
	1. Extension filtering: most of the time, it is useless to scan image files, backups etc. So the default mode for the Magento Malware Scanner is to only scan web code documents (html, js, php).

# Easy usage

Requires a Linux or Mac OSX server.

```
# download latest rules
wget https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/build/all-confirmed.txt

# do a recursive search on the Magento files in /var/www
grep -Erlf all-confirmed.txt /var/www

```

It will show you all the files with malware.

# Full usage

For faster scanning and more features, you need to install some extra software: `python-yara` and the scanner from this repository.

## Using Debian/Ubuntu Linux

```bash
# Install prerequisites on Debian/Ubuntu flavoured server
sudo apt install -qy libyara3 python-pip
sudo pip install --no-cache-dir --upgrade mwscan
``` 

## Using Mac OSX

```bash
# Install prerequisites on a Mac OSX environemnt
brew install yara python python-yara
sudo pip install --no-cache-dir --upgrade mwscan
```

## Alternatively

If pip does not work for you, you can download the scanner and the rules file manually:

```bash
curl -s https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/mwscan/mwscan.py -o mwscan
curl -s https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/build/all-confirmed.yar -o rules.yar
chmod 755 mwscan
./mwscan --rules rules.yar /Users/frosit/Werk/Security/
```

## Running manually

If you have installed through pip, you can now run this and any hits will appear
```bash
mwscan /Users/frosit/Werk/Security/mage17

# this will for example show:
eval_post /Users/frosit/Werk/Security/mage17/media/dhl/info.php
obfuscated_eval /Users/frosit/Werk/Security/mage17/skin/backdoor1.php
```

## Running from cron

It is recommended to run nightly from cron. This will download the latest rules every night, run a scan on your Magento store and mail you if anything was found. 


```
cat <<EOM | sudo tee /etc/cron.d/mwscan

MAILTO=youremail@etc

RULESURL=https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/build/all-confirmed.yar
RULEFILE=/var/cache/rules.yar
MAGENTO=/var/www/magento
MWSCAN=/usr/bin/mwscan


10 2 * * * root /usr/bin/curl -s $RULES -o $RULESFILE && $MWSCAN --quiet --newonly --rules $RULESFILE $MAGENTO

EOM

```

## Advanced cron

This cron will ensure only a single concurrent scan, will log timestamped new finds to /var/log/mwscan.log and mail them to the supplied address. Requires `util-linux`, `moreutils` and `mailutils` on Ubuntu/Debian for `flock`, `ifne`, `ts`, and `mail`.

```
MAILTO=your@address
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

0 2 * * * root flock -n ~/.mwscan.lock mwscan --newonly --quiet /data/web 2>/dev/null | ts | tee -a /var/log/mwscan.log | ifne mail -s "Malware found at $(hostname)" -a 'From: Malware Scanner <noreply@yoursite.com>' $MAILTO
```